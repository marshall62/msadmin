{% extends 'msadmin/base_ajax.html' %}
{% load staticfiles %}

{% block page-css %}
    <style>

        .modal-header, h4, .close {
            background-color: #889400;
            color:black !important;
            text-align: center;
            font-size: 30px;
        }
        .modal-footer {
            background-color: #f9f9f9;
        }
        .bs-example{
            margin: 50px;
        }
        .bs-example a{
            font-size: 22px;
            text-decoration: none;
            margin: 0 10px;
        }

         .dropdown-submenu {
             position: relative;
         }

        .dropdown-submenu .dropdown-menu {
            top: 0;
            left: 100%;
            margin-top: -1px;
        }
    </style>
{% endblock %}

{% block page-js %}


{#    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.1/react.js"></script>#}
{#    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.1/react-dom.js"></script>#}
    {#    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-bootstrap/0.31.3/react-bootstrap.min.js"></script>#}
{#    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.0-alpha1/JSXTransformer.js"></script>#}
    <script type="text/javascript" src="{% static 'js/qa/mycomponents.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/DMPulldown.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/qa/hints.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/qa/media.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/qa/answers.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/sprintf.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/util.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/chosen.jquery.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/chosen.proto.min.js' %}"></script>
    <link rel="stylesheet" href="{% static 'css/chosen.css' %}">
{#    <link rel="stylesheet" href="{% static 'css/style.css' %}">#}
{#    <link rel="stylesheet" href="{% static 'css/prism.css' %}">#}

    <script language="javascript">

        var theProblem = null; // a problem object obtained from AJAX call when page loads
        var theHint = null; // the hint currently being edited in a dialog box
        var answerType = "shortanswer"; // the currently selected answerType
        var choiceLabels = ["a", "b", "c", "d", "e"];
        var numChoices = 0; // keeps track of how many multi choice answers fields there are.
        var numAnswers = 0; // keeps track of how many short answer fields there are.

        var hintImageControls;  // an object that needs to be global because it gets manipulated by callbacks in hints.js
        var hintEditMode; // set to either NEW_HINT or EXISTING_HINT
        var idCount=0;

{#        var mediaURL = "{{ MEDIA_URL }}";#}
        {% if problem %}
        var problemDir = "{{ MEDIA_URL }}{{ qaDir }}{{ problem.getProblemDir }}";
        {% else %}
        var problemDir = "{{ MEDIA_URL }}{{ qaDir }}";
        {% endif %}

        var allStandards = null; // will be set to JSON by AJAX call when page loads

        // create constant URLs that will be used by supporting javascript files
        const SAVE_MEDIA_URL = "{% url 'qauth_save_problem_media' probId=12345 %}";
        const SAVE_META_INFO_URL = "{% url 'qauth_save_problem_meta_info' probId=12345 %}";
        const SAVE_HINTS_URL = "{% url 'qauth_save_hints' probId=12345 %}";
        const SAVE_HINT_URL = "{% url 'qauth_save_hint' probId=12345 %}";
        const GET_HINT_URL = "{% url 'qauth_get_hint' hintId=12345 %}";
        const DELETE_HINTS_URL = "{% url 'qauth_delete_hints' probId=12345 %}";
        const REMOVE_HINT_IMAGE_URL = "{% url 'qauth_remove_hint_image' hintId=12345 %}";
        const REMOVE_PROBLEM_IMAGE_URL = "{% url 'qauth_remove_problem_image' probId=12345 %}";
        const REMOVE_PROBLEM_AUDIO = "{% url 'qauth_remove_problem_audio' probId=12345 %}";
        const REMOVE_HINT_AUDIO = "{% url 'qauth_remove_hint_audio' hintId=67890%}";
        const NEW_HINT = 0;
        const EXISTING_HINT = 1;

        const PREVIEW_URL = "http://tutor.mathspring.org/woj/WoAdmin?action=AdminGetQuickAuthSkeleton&probId=%s&teacherId=-1&reload=true&zoom=1";
        const LAYOUT_TOOL_URL = "http://tutor.mathspring.org/woj/WoAdmin?action=AdminEditProblemFormat&problemId=%s";


        function createPulldownOption (value, label, description) {
            return {label: label+(description ? ("  "+description) : ""), value: value};
        }

        function saveProblemMetaInfo() {
            var form = $('#metainfoForm')[0]; // get the Javascript obj for the hint form
            var data = new FormData(form); // put all the form fields into data
            console.log("stdGrades");
            console.log(data.getAll("stdGrade"));
            console.log("stdDomains");
            console.log(data.getAll("stdDomain"));
            var probId = theProblem.id;
            var url = SAVE_META_INFO_URL.replace('12345', theProblem.id);
            $.ajax({
                url: url,
                type: "POST",
                data: data,
                processData: false,
                contentType: false,
                error: function (a, b, c) {
                    console.log("Failed to write to server! " + a.responseText + b);
                    console.log(a);
                    $('#metaInfoMessages').html("Failed to write meta info server! " + a.responseText + b);
                },
                success: function (data) {
                    var updTime = data.lastWriteTime;
                    $('#lastWriteTimeId').val(updTime);
                    var msg = data.message;
                    if (msg) {
                        $('#metaInfoMessages').html(msg);
                    }
                    else
                        $('#metaInfoMessages').html('');
                }
            });

        }



        ////////   Functions that operate on the problem /////////////

        function validateProblem () {
            // some multi-choice answer must be marked correct
            if (answerType == 'multichoice') {

                if (numChoices < 2) {
                    alert("A multi choice problem must have at least two answer choices!");
                    return false;
                }
                var numChecked = $('#multichoicetablebody tr td input[name="correctChoice"]:checked').length;
                if (numChecked != 1) {
                    alert("You must select a single multiple choice response to as the correct answer!");
                    return false;
                }
            }
            else {
                if (!hasShortAnswer()) {
                    alert("A short answer problem must have at least one answer!");
                    return false;
                }
            }
            // validate that the media refs in the statement refer to a file in the media files list.
            if (false) {
                alert("Form is not valid");
                return false;
            }
            else return true;
        }

        //
        function delCCSSRow (id) {
            $('#'+id).remove();

        }

/*    Add a div to the end of the set of rows contained in the div #ccssSelectors
   <div class="row">
            <div class="col col-sm-2">
                <div id="my-pulldown8">
                </div>
            </div>
            <div class="col col-sm-2">
                <div id="my-pulldown9">
                </div>
            </div>
            <div class="col col-sm-2">
                <div id="my-pulldown10">
                </div>
            </div>
            <div class="col col-sm-2">
                <div id="my-pulldown11">
                </div>
            </div>
            <div class="col col-sm-2">
                <div id="my-pulldown12">
                </div>
            </div>
        </div> */
        function addCCSSRow (std) {
            var div_id=genId();
            var gr_Id=genId();
            var dom_Id=genId();
            var clust_Id=genId();
            var std_Id=genId();
            var part_Id=genId();
            $('#ccssSelectors').append('<div id="' +div_id+ '" class="row">'+
{#                '<div class="col col-sm-1"><a onclick="delCCSSRow()" href="#metainfoForm"><span class="glyphicon glyphicon-minus" data-toggle="tooltip" data-original-title="Remove this standard"></span></a></div>'+#}
                '<a onclick="delCCSSRow(\'' +div_id+ '\')" href="#metainfoForm"><span class="glyphicon glyphicon-minus" data-toggle="tooltip" data-original-title="Remove this standard"></span></a>'+
                '<div class="col col-sm-2">' + pulldownDiv(gr_Id,'stdGrade','Grade') + '</div>' +
                '<div class="col col-sm-2">' + pulldownDiv(dom_Id,'stdDomain','Domain') + '</div>' +
                '<div class="col col-sm-2">' + pulldownDiv(clust_Id,'stdCluster','Cluster') + '</div>' +
                '<div class="col col-sm-2">' + pulldownDiv(std_Id,'stdStandard','Std') + '</div>' +
                '<div class="col col-sm-2">' + pulldownDiv(part_Id,'stdPart','Part') + '</div>' +
                '</div>');
            var opts = getStandardGradeOptions(allStandards);

            var ids = {grade:'#'+gr_Id, domain:'#'+dom_Id, cluster: '#'+clust_Id, standard: '#'+std_Id, part:'#'+part_Id};
            $('#'+gr_Id).DMPulldown({options: opts, selectedOption: (std ? std.grade : null), onChange: function () { resetGradeChildren(ids) }});
            if (std)
                opts = getStandardDomainOptions(allStandards,std.grade);
            else opts = [{val:"---", label:"---"}];
            $('#'+dom_Id).DMPulldown({options: opts, selectedOption: (std ? std.domain : null), onChange: function () { resetDomainChildren(ids) }});
            if (std)
                opts = getStandardClusterOptions(allStandards,std.grade,std.domain);
            else opts = [{val:"---", label:"---"}];
            $('#'+clust_Id).DMPulldown({options: opts, selectedOption: (std ? std.cluster : null), onChange: function () { resetClusterChildren(ids) }});
            if (std)
                opts = getStandardStandardOptions(allStandards,std.grade,std.domain,std.cluster);
            else opts = [{val:"---", label:"---"}];
            $('#'+std_Id).DMPulldown({options: opts, selectedOption: (std ? std.standard : null), onChange: function () { resetStandardChildren(ids) }});
            if (std)
                opts = getStandardPartOptions(allStandards,std.grade,std.domain,std.cluster,std.standard);
            else opts = [{val:"---", label:"---"}];
            $('#'+part_Id).DMPulldown({options: opts, selectedOption: (std ? std.part : null)});

        }

        function genId () {
            return 'pulldown_selector_id-' + ++idCount;
        }

        function pulldownDiv (id, name, label) {
            return '<div class="input-group"><span class="input-group-addon">' +label+ '</span><select id="' +id+ '" name="' +name+ '" class="form-control"></select> </div>'
        }


        // WHen this page loads it sends an AJAX request to get all the common core standards as an ordered dictionary.
        // The standards ultimately populate 4 pulldown menus (my-pulldown8, 9, 10, 11).
        // This function extracts the grades out of the standards and builds the first pulldown menu (8).
        // The other menus get values stuck in them when an option from grade pulldown is selected.
        // The standards JSON object is a Python OrderedDict such that the keys of this ORderedDict are the grades.
        // Thus the fields of the JSON object are the grades.
        function getStandardGradeOptions(standards) {
            var options = [];
            options.push(createPulldownOption("---","---"));
            for (var s of standards) {
                var gr = s[0];
                options.push(createPulldownOption(gr,gr));
            }
            return options;
        }

        // Given the grade, go into the standard JSON and get the value of the field for the grade and then return a list of
        // options for each field in this object.
        function getStandardDomainOptions (standards, grade) {
            var gr;
            var options = [];
            for (var s of standards) {
                if (s[0] == grade) {
                    gr = s[1];
                    break;
                }
            }
            options.push(createPulldownOption("---","---"));
            for (var d of gr) {
                var domain= d[0];
                options.push(createPulldownOption(domain,domain));
            }
            return options;
        }

        // Given the grade, go into the standard JSON and get the value of the field for the grade and then return a list of
        // options for each field in this object.
        function getStandardClusterOptions (standards, grade, domain) {
            var domains, clusters;
            var options = [];
            for (var s of standards) {
                if (s[0] == grade) {
                    domains = s[1];
                    break;
                }
            }
            for (var d of domains) {
                if (d[0] == domain) {
                    clusters = d[1];
                    break;
                }
            }
            options.push(createPulldownOption("---","---"));
            for (var clust of clusters)
                options.push(createPulldownOption(clust[0],clust[0]));
            return options;
        }

        function getStandardStandardOptions (standards, grade, domain, cluster) {
            var domains, clusters, stds;
            var options = [];
            for (var s of standards) {
                if (s[0] == grade) {
                    domains = s[1];
                    break;
                }
            }
            for (var d of domains) {
                if (d[0] == domain) {
                    clusters = d[1];
                    break;
                }
            }
            for (var clust of clusters) {
                if (clust[0] == cluster) {
                    stds = clust[1];
                    break;
                }
            }
            options.push(createPulldownOption("---","---"));
            for (var s of stds)
                options.push(createPulldownOption(s[0],s[0]));
            return options;


        }

        function getStandardPartOptions (standards, grade, domain, cluster, standard) {
            var domains, clusters, stds, parts;
            var options = [];
            for (var s of standards) {
                if (s[0] == grade) {
                    domains = s[1];
                    break;
                }
            }
            for (var d of domains) {
                if (d[0] == domain) {
                    clusters = d[1];
                    break;
                }
            }
            for (var clust of clusters) {
                if (clust[0] == cluster) {
                    stds = clust[1];
                    break;
                }
            }
            for (var std of stds) {
                if (std[0] == standard) {
                    parts = std[1];
                    break;
                }
            }
            options.push(createPulldownOption("---","---"));
            if (parts.length > 0) {
                for (var p of parts)
                    options.push(createPulldownOption(p,p));
                return options;
            }
            else return [{val:"---", label:"---"}];
        }




        // Callback function.  When this HTML file opens on an existing problem, an AJAX call is made to get the JSON
        // of the problem.  The JSON data is sent to this function to initialize internal state in the page's javascript
        function problemInit (data) {
            theProblem = data;
            answerType = theProblem.questType;
            validateHints();
            if (answerType == 'multichoice') {
                numChoices = theProblem.answers.length;
                numAnswers = 0;
            }
            else {
                numAnswers = theProblem.answers.length;
                numChoices = 0;
            }

            if (theProblem.isMultiChoice)
                exposeMultiChoiceControls();
            else
                exposeShortAnswerControls();
        }

        function removeProblemImage (problemImageControls) {
            if (confirm("Do you want to remove the problem image")) {
                // send the delete request and remove the image div from the problem form
                var url_mask = REMOVE_PROBLEM_IMAGE_URL.replace('12345', theProblem.id);
                $.ajax({
                    url: url_mask,
                    type: "DELETE",
                    error: function (a, b, c) {
                        alert("Failed to get problem " + a.responseText + b);
                    },
                    success: function (data) {
                        console.log("successful delete of problem image");
                        problemImageControls.removeImage();
                    }
                });
            }
        }

        function removeProblemAudio () {
            if (confirm("Do you want to remove the problem audio")) {
                // send the delete request and remove the image div from the problem form
                var url_mask = REMOVE_PROBLEM_AUDIO.replace('12345', theProblem.id);
                $.ajax({
                    url: url_mask,
                    type: "DELETE",
                    error: function (a, b, c) {
                        alert("Failed to get problem " + a.responseText + b);
                    },
                    success: function (data) {
                        console.log("successful delete of problem audio");
                        resetProbAudioControls();
                    }
                });
            }
        }

        function removeHintAudio () {
            if (confirm("Do you want to remove the hint audio")) {
                // send the delete request and remove the image div from the problem form
                var url_mask = REMOVE_HINT_AUDIO.replace('67890',theHint.id);
                $.ajax({
                    url: url_mask,
                    type: "DELETE",
                    error: function (a, b, c) {
                        alert("Failed to get problem " + a.responseText + b);
                    },
                    success: function (data) {
                        console.log("successful delete of problem audio");
                        resetHintAudioControls();
                    }
                });
            }
        }

        function resetHintAudioControls () {
            $('#hintAudio').hide();
            $('#haudioResource').val('');
        }

        function resetProbAudioControls () {
            $('.remove_problem_audio').remove();
            $('#problem_audio_player').remove();
            $('#audioResource').val('');
        }

        function showPreview () {
            var url = sprintf(PREVIEW_URL,theProblem.id);
            window.open(url);
        }

        function openLayoutTool () {
            var url = sprintf(LAYOUT_TOOL_URL,theProblem ? theProblem.id : "");
            window.open(url);
        }

        function initializeLayoutPulldown () {
            var url_mask = "{% url 'qauth_layouts' %}";
            $.ajax({
                url: url_mask,
                type: "GET",
                error: function (a,b,c) {
                    alert("Failed to get layouts " + a.responseText + b);
                },
                success: function (data) {
                    var layoutOpts = data;
                    var opts = layoutOpts.map(function (o) { return createPulldownOption(o.id,o.name, o.description)})
                    {% if problem %}
                        mountPulldownComponent('my-pulldown4',{label:"Layout Template", myId:"layout", myName:"layout", selectedOption:"{{ problem.getLayoutId }}", options: opts});
                    {% else %}
                        mountPulldownComponent('my-pulldown4',{label:"Layout Template", myId:"layout", myName:"layout", options: opts});
                    {% endif %}


                }
            });
        }

        function resetStandardChildren (stdPulldownIds) {
            var grade = $(stdPulldownIds.grade).val();
            var domain = $(stdPulldownIds.domain).val();
            var clust = $(stdPulldownIds.cluster).val();
            var std = $(stdPulldownIds.standard).val();
            var opts = [{val:"---", label:"---"}];
            if (std != "---")
                opts = getStandardPartOptions(allStandards,grade,domain, clust,std);
            $(stdPulldownIds.part).setDMPulldownOptions({options: opts});
        }


        // If a new cluster is chosen, populate the standard pulldown based on the children of the new category
        function resetClusterChildren (stdPulldownIds) {
            var grade = $(stdPulldownIds.grade).val();
            var domain = $(stdPulldownIds.domain).val();
            var opts = [{val:"---", label:"---"}];
            var clust = $(stdPulldownIds.cluster).val();
            if (clust != "---")
                opts = getStandardStandardOptions(allStandards,grade,domain, clust);
            $(stdPulldownIds.standard).setDMPulldownOptions({options: opts});
            opts = [{val:"---", label:"---"}];
            $(stdPulldownIds.part).setDMPulldownOptions({options: opts});
        }

        function resetDomainChildren (stdPulldownIds) {
            var grade = $(stdPulldownIds.grade).val();
            var opts = [{val:"---", label:"---"}];
            var domain = $(stdPulldownIds.domain).val();
            if (domain != "---")
                opts = getStandardClusterOptions(allStandards,grade,domain);

            $(stdPulldownIds.cluster).setDMPulldownOptions({options: opts});
            opts = [{val:"---", label:"---"}];
            $(stdPulldownIds.standard).setDMPulldownOptions({options: opts});
            $(stdPulldownIds.part).setDMPulldownOptions({options: opts});

        }

        function resetGradeChildren (stdPulldownIds) {
            var grade = $(stdPulldownIds.grade).val();
            var opts;
            if (grade == '---')
                opts = [{val:"---", label:"---"}];
            else opts = getStandardDomainOptions(allStandards,grade);

            $(stdPulldownIds.domain).setDMPulldownOptions({options: opts});
            opts = [{val:"---", label:"---"}];
            $(stdPulldownIds.cluster).setDMPulldownOptions({options: opts});
            $(stdPulldownIds.standard).setDMPulldownOptions({options: opts});
            $(stdPulldownIds.part).setDMPulldownOptions({options: opts});

        }

        function setStandardPulldowns (ids, std) {
            var opts = getStandardGradeOptions(allStandards);
            $(ids.grade).DMPulldown(
                {
                    selectedOption: std ? std.grade : null,
                    options: opts,
                    onChange: function () { resetGradeChildren(ids) }
                }
            );
            if (std)
                opts = getStandardDomainOptions(allStandards, std.grade);
            else
                opts = [{val:"---", label:"---"}];
            $(ids.domain).DMPulldown(
                {
                    options: opts,
                    onChange: function () { resetDomainChildren(ids)} ,
                    selectedOption: std ? std.domain : null
                }
            );
            if (std)
                opts = getStandardClusterOptions(allStandards, std.grade,std.domain);
            else
                opts = [{val:"---", label:"---"}];
            $(ids.cluster).DMPulldown(
                {
                    options: opts,
                    onChange: function () { resetClusterChildren(ids)} ,
                    selectedOption: std ? std.cluster : null
                }
            );
            if (std)
                opts = getStandardStandardOptions(allStandards, std.grade,std.domain,std.cluster);
            else
                opts = [{val:"---", label:"---"}];
            $(ids.standard).DMPulldown(
                {
                    options: opts,
                    onChange: function () { resetStandardChildren(ids)} ,
                    selectedOption: std ? std.standard : null
                }
            );
            if (std)
                opts = getStandardPartOptions(allStandards, std.grade,std.domain,std.cluster,std.standard);
            else
                opts = [{val:"---", label:"---"}];
            $(ids.part).DMPulldown(
                {
                    options: opts,
                    selectedOption: std && std.part ? std.part : null
                }
            );
        }


        function initializeStandardPulldowns () {
            var url_mask = "{% url 'qauth_standards' probId='12345' %}";
            url_mask = url_mask.replace("12345", "{{ probId }}");
            $.ajax({
                url: url_mask,
                type: "GET",
                error: function (a,b,c) {
                    alert("Failed to get standards " + a.responseText + b);
                },
                success: function (data) {
                    allStandards = data.allStandards;
                    var primaryStandard = data.primaryStandard; // may be absent
                    var probStandards = data.probStandards; // may be absent
                    var opts = getStandardGradeOptions(allStandards);
                    var stdPulldownIds = {
                        grade: '#my-pulldown8',
                        domain:'#my-pulldown9',
                        cluster: '#my-pulldown10',
                        standard: '#my-pulldown11',
                        part: '#my-pulldown12'
                    }
                    // TODO The first CCSS row needs to be deleteable but this means some
                    // additional work to make sure one CCSS is always remaining.
                    setStandardPulldowns(stdPulldownIds,primaryStandard);
                    if (probStandards)
                        for (std of probStandards) {
                            addCCSSRow(std);
                        }

                }
            });

        }


        ///////////   The main function called at page load time /////////////////

        // loads the pulldowns with their options
        // The main function runs when the page is onReady
        $(function () {

            $('[data-toggle="tooltip"]').tooltip({
                placement : 'top'
            });
            // This makes dynamically added elements with tooltips work correctly
            $('body').tooltip({selector:'[data-toggle=tooltip]'});

            // by default we expose the short answer controls.
            // This will be replaced by appropriate controls if we are loading an existing problem
            exposeShortAnswerControls()


            $('#addChoice').click(function (x) {
                addMultiChoiceRows(1);
            });


            $('#addAnswer').click(function (x) {
                addShortAnswerRows(1);
            });

            $('#hinttbody').sortable();
            $( ".dnd" ).droppable({
                drop: function( event, ui ) {

                }
            });
            $('.dnd').on('drop',function (event, ui) {

            });
            $( "#hinttbody" ).on( "sortstop", function( event, ui ) {
                validateHints();
                saveHintsToServer(); // save hints to server even if not valid because model has to be kept consistent
            } );

            $('.remove_problem_audio').click(function () {
                removeProblemAudio();
            })
            $('.remove_hint_audio').click(function () {
                removeHintAudio();
            });
            $('#hintSave').click(function (x) {
                saveHint(false);

            });
            $('#previewButton').click(function (x) {
                showPreview();
            });
            $('#hintSaveExit').click(function (x) {
                saveHint(true);
            });
            // rather than do a $('.delChoice').click() to handle clicks on the elements with delChoice class
            // we use this method of listening for click events on elements with this class.  This is necessary
            // because elements with the delChoice class are added dynamically and they won't be handled correctly
            // by the ordinary click handling and must be done this way.  See:
            // https://stackoverflow.com/questions/203198/event-binding-on-dynamically-created-elements
            $(document).on('click', '.delChoice', function(){
                deleteMultiChoiceRow($(this));
            });
            $(document).on('click', '.delShortAnswer', function(){
                deleteAnswerRow($(this));
            });

            // handle the click on the X next to a hint image to get rid of it.
            $('.delHintImage').click(function () {
                deleteHintImage();

            });

            $('.dropdown-submenu a.test').on("click", function(e){
                $(this).next('ul').toggle();
                e.stopPropagation();
                e.preventDefault();
            });

            $("#topicSelect").chosen({
                no_results_text: "Oops, nothing found!",
                width: "95%"
            });
{#            $("#topicSelect").on('change', function () { alert("selected topics " + $('#topicSelect').val()) });#}
            {% if problem and problem.imageURL %}
                var imgURL = '{{ problem.imageURL }}';
            {% else %}
                var imgURL = null;
            {% endif %}
            {% if problem and problem.imageFile != None %}
                var imgFilename = '{{ problem.imageFile.filename }}';
                var imgFileId = '{{ problem.imageFile.id }}';
            {% else %}
                var imgFilename = null;
                var imgFileId = null;
            {% endif %}
            {% if problem %}
                var imgURI = '{{ MEDIA_URL }}{{ qaDir }}{{ problem.getProblemDir }}'; // URI to image within our apache root . Add on imageFilename for full URL
            {% else %}
                var imgURI = '{{ MEDIA_URL }}{{ qaDir }}';
            {% endif %}
            var problemImageControls = new ImageControls(imgURL,imgFilename,imgFileId,imgURI);
            problemImageControls.mountComponent('problemImageControls',{imageFileName:'imageFile', delImageClassName: 'a_problem_delete_img'});
            // handle the click on the X next to a problem image to get rid of it.
            $(document).on('click', '.a_problem_delete_img', function(){
                removeProblemImage(problemImageControls);
            });

            // The problem and hint both preview the image and have an X icon that can be clicked to remove the hint
            // from the problem/hint.   This is the listener.
            $(document).on('click', '.a_hint_delete_img', function(){
                removeHintImage(hintImageControls);
            });

            $('#my-pulldown2').change(function (x) {
                var val = $('#questType').val();
                answerType = val;
                if (val == 'shortanswer') {
                    $('#shortAnswer').show();
                    $('#multichoices').hide();

                    if (numAnswers == 0)
                        addShortAnswerRows(1);
                }
                else {
                    $('#shortAnswer').hide();
                    $('#multichoices').show();
                    if (numChoices == 0)
                        addMultiChoiceRows(2);
                }
            });

            {% if probId != -1 %}
                mountPulldownComponent('my-pulldown2',{label:"Answer Type", myId:"questType", myName:"questType", selectedOption:"{{ problem.questType }}", options:[{value:'multichoice',label:'Multiple Choice'}, {value:'shortanswer',label:'Short Answer'}]});
                mountPulldownComponent('my-pulldown3',{label:"Status", myId:"status", myName:"status", selectedOption:"{{ problem.getStatus3 }}", options:[{value:'ready',label:'Ready'}, {value:'testable',label:'Testable'}, {value:'dead',label:'Dead'}]});
                mountPulldownComponent('my-pulldown7',{label:"Difficulty", myId:"difficulty", myName:"difficulty", isDisabled:{%if problem.isDifficultyDisabled == True %}true{% else %}false{% endif %}, selectedOption:"{{ problem.getDifficulty }}", options:[{value:'-1', label:'---'}, {value:'0',label:'0'},{value:'1',label:'1'}, {value:'2',label:'2'}, {value:'3',label:'3'},{value:'4',label:'4'},
                    {value:'5',label:'5'},{value:'6',label:'6'},{value:'7',label:'7'},{value:'8',label:'8'},{value:'9',label:'9'}]});
                mountPulldownComponent('my-pulldown6',{label:"Usable as Example", myId:"usableExample", myName:"usableAsExample", selectedOption:"{{ problem.usableAsExample }}", options:[{value:'True',label:'Yes'}, {value:'False',label:'No'}]});
            {% else %}
                mountPulldownComponent('my-pulldown2',{label:"Answer Type", myId:"questType", myName:"questType", selectedOption:"shortanswer", options:[{value:'multichoice',label:'Multiple Choice'}, {value:'shortanswer',label:'Short Answer'}]});
                mountPulldownComponent('my-pulldown3',{label:"Status", myId:"status", myName:"status", selectedOption:"testable", options:[{value:'ready',label:'Ready'}, {value:'testable',label:'Testable'}, {value:'dead',label:'Dead'}]});
                mountPulldownComponent('my-pulldown7',{label:"Difficulty", myId:"difficulty", myName:"difficulty", selectedOption:"-1", options:[{value:'-1', label:'---'}, {value:'0',label:'0'},{value:'1',label:'1'}, {value:'2',label:'2'}, {value:'3',label:'3'},{value:'4',label:'4'},
                    {value:'5',label:'5'},{value:'6',label:'6'},{value:'7',label:'7'},{value:'8',label:'8'},{value:'9',label:'9'}]});

            {% endif %}
            var url_mask;
            url_mask = "{% url 'qauth_get_problem' probId=12345 %}";
{#            if the probId is valid, make an ajax call to get the problem JSON #}
            {% if probId != -1 %}
                url_mask = url_mask.replace("12345", "{{ probId }}");
            $.ajax({
                url: url_mask,
                type: "GET",
                error: function (a,b,c) {
                    alert("Failed to get problem " + a.responseText + b);
                },
                success: function (data) {
                    problemInit(data);

                }
            });
            {% endif %}
            initializeLayoutPulldown();
            initializeStandardPulldowns();
        });


    </script>
{% endblock %}


{% block content %}
    {% if probId == -1 %}
    <h3>Create a new math problem</h3>
    {% else %}
    <h3>Edit a math problem</h3>
    {% if errors %}<span style="color:red;">There are errors that must be corrected. See message below</span>{% endif %}
    {% endif %}

    <form method="post" enctype="multipart/form-data" onsubmit="return validateProblem();" action="{% url 'qauth_save_prob' %}">
        {% csrf_token %}

        <div class="form-group">
            <div class="row">
                <div class="col col-sm-3">
                    <div class="input-group">
                        <span class="input-group-addon">ID</span>
                        {% if probId == -1 %}
                            <input id="id" type="text" class="form-control" name="id" readonly placeholder="--">
                        {% else %}
                            <input id="id" type="text" class="form-control" name="id" readonly value = "{{ problem.id }}" placeholder="--">
                        {% endif %}

                    </div>
                </div>
                <div class="col col-sm-5">
                    <div class="input-group ">
                        <span class="input-group-addon">Name</span>
                        {% if probId == -1 %}
                            <input id="name" type="text" class="form-control" name="name" placeholder="Problem Name">
                        {% else %}
                            <input id="name" type="text" class="form-control" name="name" value = "{{ problem.name }}" placeholder="Problem Name">
                        {% endif %}

                    </div>
                </div>
            </div>
        <br>
        <div class="input-group">
            <span class="input-group-addon">Nick Name</span>
            {% if probId == -1 %}
                <input id="nickname" type="text" class="form-control" name="nickname" placeholder="Nick Name">
            {% else %}
                <input id="nickname" type="text" class="form-control" name="nickname" value = "{{ problem.nickname }}" placeholder="Nick Name">
            {% endif %}

        </div>
        <br>

        <div class="input-group">
            <span class="input-group-addon">Statement</span>
            {% if probId == -1 %}
                <textarea rows="8" cols="80" name="statementHTML" class="form-control" id="statementHTML"></textarea>
            {% else %}
                <textarea rows="8" cols="80" name="statementHTML" class="form-control" id="statementHTML">{{ problem.statementHTML }}</textarea>
            {% endif %}

        </div>
        <br>
        <div class="form-inline">
            <div class="input-group">
                <span class="input-group-addon">Audio File</span>
                {% if probId == -1 %}
                    <input id="audioResource" type="text" class="form-control" readonly name="audioResource" placeholder="">
                {% else %}
                    <input id="audioResource" type="text" class="form-control" readonly name="audioResource" value = "{{ problem.audioResource }}">
                {% endif %}

            </div>
            <input class="form-control mb-2 mr-sm-2 mb-sm-0" name="audioFile" type="file">
            <a href="#"><span class="glyphicon glyphicon-question-sign" data-toggle="tooltip" data-original-title="A sound file that plays when the hint is shown"></span></a>
            {% if problem and problem.audioResource %}
                <audio id="problem_audio_player" controls>
                    <source src="{{ MEDIA_URL }}{{ qaDir }}{{ problem.getProblemDir }}/{{ problem.getAudioFile }}" type="audio/mpeg">
                    Your browser does not support the audio tag.
                </audio>
                <a class="remove_problem_audio" href="#">
                    <span class="glyphicon glyphicon-remove" data-toggle="tooltip" data-original-title="Remove this audio from the problem"></span>
                </a>
            {% endif %}
        </div>

        <br>
            {#   The below div is filled with ImageControls in the page load js function#}
        <div id="problemImageControls" class="form-inline">
        </div>
        <br>

        <div class="form-inline">
            {% if probId == -1 %}
                <div id="my-pulldown2" class="input-group mb-2 mr-sm-2 mb-sm-0" label="Answer Type" myId="questType" myName="questType" selectedOption="shortanswer"></div>
            {%  else %}
                <div id="my-pulldown2" class="input-group mb-2 mr-sm-2 mb-sm-0" label="Answer Type" myId="questType" myName="questType" selectedOption="{{ problem.questType }}"></div>
            {% endif %}



        </div>
        <br>
        <div id="shortAnswer" class="input-group mb-2 mr-sm-2 mb-sm-0" >
            <a id="addAnswer" href="#shortAnswer"><span class="glyphicon glyphicon-plus" data-toggle="tooltip" data-original-title="Add a short answer"></span></a>
            <table id="shortanswertable" class="table table-bordered">
                <thead><tr><th style="width: 60px">Delete</th>
                    <th>Value <a href="#shortAnswer"><span class="glyphicon glyphicon-question-sign" data-toggle="tooltip" data-original-title="Each row should have a possible correct answer (e.g. 4, 4.0, 8/2)"></span></a>
                    </th></tr></thead>
                <tbody id="shortanswertablebody">
                {% if probId != -1 and problem.isShortAnswer %}

                    {% for c in problem.getAnswers %}

                        <tr><td class="deleteButton">
                            <a class="delShortAnswer" href="#shortanswertable">
                                <span class="glyphicon glyphicon-remove" data-toggle="tooltip" data-original-title="Delete this answer"></span>
                            </a>
                        </td>
                            <td>
                                <div class="row">
                                    <div class="form-group col-lg-12">
                                        <input id="answer-{{ forloop.counter0 }}" name="shortanswer[]" type="text" class="form-control" value="{{ c.val }}"/>
                                    </div>
                                </div>
                            </td></tr>
                    {% endfor %}
                {% elif probId == -1  %}
                    <tr><td class="deleteButton">
                        <a class="delShortAnswer" href="#shortanswertable">
                            <span class="glyphicon glyphicon-remove" data-toggle="tooltip" data-original-title="Delete this answer"></span>
                        </a>
                    </td>
                        <td>
                            <div class="row">
                                <div class="form-group col-lg-12">
                                    <input id="answer-0" name="shortanswer[]" type="text" class="form-control" value=""/>
                                </div>
                            </div>
                        </td></tr>
                {% endif %}

                </tbody>
            </table>


        </div>

        <div id="multichoices">
            <a id="addChoice" href="#multichoices"><span class="glyphicon glyphicon-plus" data-toggle="tooltip" data-original-title="Add a choice answer"></span></a>
            <table id="multichoicetable" class="table table-bordered">
                <thead><tr><th style="width: 60px">Delete</th><th style="width: 60px">Choice</th><th style="width: 60px">Correct</th>
                    <th>Value <a href="#multichoices"><span class="glyphicon glyphicon-question-sign" data-toggle="tooltip" data-original-title="Value or image URL like {[myimage.jpg]}"></span></a>
                    </th></tr></thead>
                <tbody id="multichoicetablebody">
                    {% if probId != -1 and problem.isMultiChoice %}

                        {% for c in problem.getAnswers %}

                            <tr>
{#                                <td><input name="deleteChoice" type="checkbox"></td>#}
                                <td class="deleteButton">
                                    <a class="delChoice" href="#multichoices">
                                    <span class="glyphicon glyphicon-remove" data-toggle="tooltip" data-original-title="Delete this choice"></span>
                                    </a>
                                </td>
                                <td class="choiceLabel">{{ c.choiceLetter }}</td>
                                <td class="choiceCorrect">
                                    <input class="correctRadio" type="radio" name="correctChoice" {% if c.choiceLetter == problem.answer %} checked {% endif %} value="{{ c.choiceLetter }}">
                               </td>
                                <td>
                                    <div class="row">
                                       <div class="form-group col-lg-12">
                                           <input id="choice-{{ forloop.counter0 }}" name="multichoice[]" type="text" class="form-control" value="{{ c.val }}"/>
                                       </div>
                                    </div>
                                </td></tr>
                        {% endfor %}
                    {% endif %}
                </tbody>
            </table>
        </div>
        <br>
{#       difficulty and  Status pulldowns #}
        <div class="row">
            <div class="col col-sm-4">
                <div id="my-pulldown7" >
                </div>
            </div>
            <div class="col col-sm-4">
                {% if problem %}
                    <div id="my-pulldown3" label="Status" myId="status" myName="status" selectedOption="{{ problem.getStatus3 }}">
                {% else %}
                    <div id="my-pulldown3" label="Status" myId="status" myName="status">
                {% endif %}
                </div>
            </div>
        </div>
{#        Layout controls#}
        <br>
        <div class="row">
            <div class="col col-sm-6">
                <div id="my-pulldown4"></div>
            </div>
            <div class="col col-sm-2">
                <a onclick="openLayoutTool()" class="btn btn-primary">Layout Tool</a>
            </div>
            <div class="col col-xs-2">
                <a href="#"><span class="glyphicon glyphicon-question-sign" data-toggle="tooltip" data-original-title="Use the layout tool to create a layout and copy/paste the string into the layout field below"></span></a>
            </div>
        </div>
        <br>


        <div class="input-group">
            <span class="input-group-addon">Layout</span>
            {% if probId == -1 or problem.problemFormat == None %}
                <input type="text" class="form-control" name="problemFormat" placeholder="Layout string from Layout Tool goes here">
            {% else %}
                <input type="text" class="form-control" name="problemFormat"  value = "{{ problem.problemFormat }}">
            {% endif %}
            <span class="input-group-addon">
                <a href="#"><span class="glyphicon glyphicon-question-sign" data-toggle="tooltip" data-original-title="Copy/paste from layout tool"></span></a>
            </span>

        </div>




        <br/>


        <br>
        <button id="saveButton" class="btn btn-primary">Save</button>
        {% if probId != -1 %}
{#            specifying type=button prevents the button from submitting the form #}
        <button type="button" id="previewButton" class="btn btn-primary">Preview</button>
        {% endif %}
        </div>

        {% if message %}
            <p style="color: red" id="problemMessage">{% autoescape off %}{{ message }}{% endautoescape %}</p>
        {% endif %}

    </form>



    {% if probId != -1 %}
        <div class="container"></div>
        <div id="probTabs" class="container">
            <ul class="nav nav-tabs">
                <li class="active">
                    <a  href="#tab1" data-toggle="tab">Hints</a>
                </li>
                <li><a href="#tab2" data-toggle="tab">Media Files</a>
                </li>
                <li><a href="#tab3" data-toggle="tab">Meta Info</a>
                </li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane active" id="tab1">
                    <a id="addHint" onclick="addHint()" href="#hintTable"><span class="glyphicon glyphicon-plus" data-toggle="tooltip" data-original-title="Add a hint"></span></a>
{#                    <a id="delHint" onclick="deleteSelectedHints({{ problem.id }})" href="#hintTable"><span class="glyphicon glyphicon-minus" data-toggle="tooltip" data-original-title="Delete selected hints"></span></a>#}
                    &nbsp; &nbsp;
                    Drag and Drop rows to reorder hints

                    <table id="hintTable" class="table table-bordered pagin-table">
                        <thead>
                        <tr><td style="width: 30px">Delete</td><th style="width: 60px">Edit</th><th style="width: 30px">ID</th><th style="width: 30px">answer</th><th >statement</th></tr>
                        </thead>
                        <tbody id="hinttbody">
                                put the hint id in the tr as the id so that when delete is executed we can easily find the selected hints
                        {% for h in hints %}

                            <tr id="{{ h.id }}" class="dnd">
                                <td>
                                    <input type="checkbox"></td>
                                <td class="edit-hint"><a href="#hinttbody" class="hint-edit-icon" onClick="editHint2({{ h.id }}, problemDir)"><span class="glyphicon glyphicon-pencil" data-toggle="tooltip" data-original-title="Edit this hint"></span></a></td>
                                <td class="hint-id">{{ h.id }}</td>

                                <td class="givesAnswer">{% if h.givesAnswer %}<span class="glyphicon glyphicon-ok"></span>{% endif %}</td>

                                                <td class="name"><a href="#" class="hint-name-label" onClick='editHint2({{ h.id }})'>{{ h.name }}</a></td>
                                <td class="statement"> {{ h.statementHTML }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    {% if problem %}
                        <a href="#hintTable" class="btn btn-primary" onClick="deleteSelectedHints({{ problem.id }})">Delete Selected Hints</a>
                    {% else %}
                        <a href="#hintTable" class="btn btn-primary">Save Changes to Hints</a>
                    {% endif %}
{#                    <a id="testButton" onclick="validateHints()" href="#hintTable"><span class="glyphicon glyphicon-scale" data-toggle="tooltip" data-original-title="Add alert"></span></a>#}
{#                    <a id="testButton2" onclick="setHintAlert (2, 'hi')" href="#hintTable"><span class="glyphicon glyphicon-scale" data-toggle="tooltip" data-original-title="Remove alert"></span></a>#}
                    <p style="color: red" id="hintErrorMessages"></p>
                </div>

                <div class="tab-pane" id="tab2">
                    <form id="mediaFilesForm" method="post" enctype="multipart/form-data" onsubmit="return validateProblem();" action="{% url 'qauth_save_problem_media' probId=probId %}">
                        {#        <div class="input-group">#}
                        {% csrf_token %}


                        <a id="addMedia" onclick="addMediaRow()" href="#mediaTable"><span class="glyphicon glyphicon-plus" data-toggle="tooltip" data-original-title="Add a media file"></span></a>


                        <table id="mediaTable" class="table table-bordered">
                            <thead>
                            <tr><td style="width: 60px">Delete</td><th style="width: 60px">ID</th><th style="width: 60px">Ref file name</th><td>Upload</td></tr>
                            </thead>
                            <tbody id="mediatbody">
                            {#        put the hint id in the tr as the id so that when delete is executed we can easily find the selected hints #}
                            {% for f in problem.getMediaFiles %}
                                <tr id="{{ f.id }}"><td><input type="checkbox"></td><td>{{ f.id }}</td><td>{[{{ f.filename }}]}</td>
                                    <td></td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                        <div style="color:red;" id="mediaFileErrorMessages">

                        </div>
                        {#        save will submit the form, deleting will ajax the ids to server but will keep the page where it is#}
                        {#        <button  class="btn btn-primary" onClick="$('mediaFilesForm').submit();">Save Changes to Media Files</button>#}
                        <a href="#mediaTable" class="btn btn-primary" onClick="saveMediaFiles()">Save Changes to Media Files</a>
                    </form>
                </div>

                <div class="tab-pane" id="tab3">
                    <form id="metainfoForm">
                        <br>
{#                        <div class="form-inline">#}
{#                            <div class="input-group">#}
                        <div id="ccssSelectors">
                            <div class="row">
                                <a id="addMedia" onclick="addCCSSRow()" href="#metainfoForm"><span class="glyphicon glyphicon-plus" data-toggle="tooltip" data-original-title="Add a CCSS"></span></a>

                            </div>
                            <div class="row">
                                <div class="col col-sm-2">
                                    <div class="input-group">
                                        <span class="input-group-addon">Grade</span>
                                        <select id="my-pulldown8" name='stdGrade' class="form-control"></select>
                                    </div>

                                </div>
                                <div class="col col-sm-2">
                                    <div class="input-group">
                                        <span class="input-group-addon">Domain</span>
                                        <select id="my-pulldown9" name='stdDomain' class="form-control"></select>
                                    </div>
                                </div>
                                <div class="col col-sm-2">
                                    <div class="input-group">
                                        <span class="input-group-addon">Cluster</span>
                                        <select id="my-pulldown10" name='stdCluster' class="form-control"></select>
                                    </div>
                                </div>
                                <div class="col col-sm-2">
                                    <div class="input-group">
                                        <span class="input-group-addon">Std</span>
                                        <select id="my-pulldown11" name='stdStandard' class="form-control"></select>
                                    </div>
                                </div>
                                <div class="col col-sm-2">
                                    <div class="input-group">
                                        <span class="input-group-addon">Part</span>
                                        <select id="my-pulldown12" name='stdPart' class="form-control"></select>
                                    </div>
                                </div>
{#                                <input id="standardId" type="text" class="form-control" name="standardId" value = "{{ problem.standardId }}">#}
                            </div>
                        </div>
{#                            <div class="input-group">#}
{#                                <span class="input-group-addon">Domain ID</span>#}
{#                                <input id="clusterId" type="text" class="form-control" name="clusterId" value = "{{ problem.clusterId }}">#}
{#                            </div>#}
{#                        </div>#}
                        <br>
                    <div class="input-group">
                        <span class="input-group-addon">Topic</span>
                        <select id="topicSelect" name="topic" data-placeholder="Choose Topics" class="chosen-select form-control" multiple tabindex="4">
                            {% for t in allTopics %}
                                <option value="{{ t.id }}" {% if t.isSelected %} selected {% endif %}>{{ t.description }}</option>
                            {% endfor %}

                        </select>
                    </div>
                    <br>
                        <div class="form-inline">
                            <div class="input-group">
                                <span class="input-group-addon">Video ID</span>
                                    <input id="videoId" type="text" class="form-control" name="video" value = "{{ problem.video }}">

                            </div>


                            <div class="input-group">
                                <span class="input-group-addon">Example ID</span>
                                    <input id="exampleId" type="text" class="form-control" name="example" value = "{{ problem.example }}">

                            </div>
                        </div>
                        <br>
                        <div class="row">
                            <div class="col col-sm-4">
    {#                             Pulldown menu for IsAllowedAsExample #}
                                    <div id="my-pulldown6"></div>
                            </div>

                            <div class="col col-sm-2">
                                {#                             Pulldown menu for IsAllowedAsExample #}
                                <input type="checkbox" readonly {% if problem.hasSnapshot %} checked {% endif %}> Has Snapshot</input>
                            </div>

                            <div class="col col-sm-6">
                                <input id="snapshotfile" type="file" class="form-control-file" name="snapshotFile">
                            </div>
                        </div>
                        <br>
                        {% if problem.hasSnapshot %}
                        <div class="form-group">
                            <label for="snapshotPreview">Snapshot Image</label>
                            <img id="snapshotPreview" src="{{ MEDIA_URL }}{{ SNAPSHOT_DIRNAME }}/{{ problem.getSnapshotFilename }}"
                                 onmouseover="this.removeAttribute('width'); this.removeAttribute('height');"
                                 onmouseout="this.width='70'; this.height='70';" width="70" height="70">
                        </div>
                        {% endif %}
                        <br>
                        <div class="row">
                            <div class="col col-sm-5">
                                <div class="input-group ">
                                    <span class="input-group-addon">Creator</span>
                                        <input id="creatorId" type="text" class="form-control" name="creator" readonly value = "{{ problem.creator }}">

                                </div>
                            </div>
                            <div class="col col-sm-5">
                                <div class="input-group ">
                                    <span class="input-group-addon">Last Modifier</span>
                                        <input id="lastModifierId" type="text" class="form-control" name="lastModifier" readonly value = "{{ problem.lastModifier }}">

                                </div>
                            </div>
                        </div>
                        <div class="row">

                            <div class="col col-sm-5">
                                <div class="input-group" >
                                    <span class="input-group-addon">Cr. Time</span>
                                        <input id="crTimeId" type="text" readonly class="form-control" name="creationTime" value = "{{ problem.created_at }}">

                                </div>
                            </div>
                            <div class="col col-sm-5">
                                <div class="input-group ">
                                    <span class="input-group-addon">Last Wr. Time</span>
                                        <input id="lastWriteTimeId" type="text" readonly class="form-control" name="lastWriteTime" value = "{{ problem.updated_at }}">

                                </div>
                            </div>
                        </div>

                        <br>
                        <div class="input-group">
                            <span class="input-group-addon">Notes</span>
                                <textarea rows="3" cols="80" name="authorNotes" class="form-control" id="authorNotesId">{{ problem.authorNotes }}</textarea>

                        </div>
                        <br>
                        <a href="#metainfoForm" class="btn btn-primary" onClick="saveProblemMetaInfo()">Save Meta Info</a>
                        <p style="color: red" id="metaInfoMessages"></p>

                    </form>
                </div>
            </div>
        </div>


    {% endif %}

{#    Don't want a hint dialog if this is a new problem.   Wait until it has an id.#}
    {% if probId != -1 %}
    <!-- Modal Dialog that will come up when hint name is clicked-->
    <div class="modal fade" id="hintDialog" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div id="dialogHeader" class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 id="param-dialog-title" class="modal-title">Edit Hint</h4>
                </div>
                <div class="modal-body" style="padding:40px 50px;">
                    <form id='hintForm' role="form" method="post" enctype="multipart/form-data" onsubmit="return validateHint();" action="{% url 'qauth_save_hint' probId=probId %}">

                        {% csrf_token %}
                        <div class="form-group">
                            <label for="hid">ID</label>
                            <input type="text" name="id" class="form-control" id="hid" readonly>
                        </div>

                        <div class="form-group">
                            <label for="hstatement">Statement</label>
                            <textarea id="hstatement" name="statementHTML" class="form-control" rows="6" cols="50"></textarea>
                        </div>
{#                        <div class="form-group">#}
{#                            <label for="hoverText">Hover Text</label>#}
{#                            <input type="text" name="hoverText" class="form-control" id="hoverText">#}
{#                        </div>#}
                        <div class="checkbox">
                            <label><input type="checkbox" name="givesAnswer" value="" id="givesAnswer" checked>Gives Answer</label>
                        </div>

{#                        First Accordian for Main Image and audio #}
                        <div id="accordion" role="tablist">
                            <div class="card">
                                <div class="card-header" role="tab" id="headingOne">
                                    <h5 class="mb-0">
                                        <a data-toggle="collapse" href="#collapseOne" role="button" aria-expanded="true" aria-controls="collapseOne">
                                            Main Hint Image and Audio
                                        </a>
                                    </h5>
                                </div>
                                <div id="collapseOne" class="collapse" role="tabpanel" aria-labelledby="headingOne" data-parent="#accordion">
                                    <div class="card-body">
                                        <div class="form-group row">
                                            <div class="col-sm-4">
                                                <label for="haudioFile">Audio Resource</label>
                                                <input id="haudioFile" class="form-control-file"  name="audioFile" type="file">
                                            </div>
                                        </div>
                                        <div class="form-group row" id="hintAudio">
                                            <audio class="col-sm-6" id="haudioPlayer" controls>
                                                <source id="hintAudioMP3" src="" type="audio/mpeg">
                                                Your browser does not support the audio tag.
                                            </audio>
                                            <a id="haudioFilename"></a>
                                            <a id="removeHintAudio" class="remove_hint_audio" href="#">
                                                <span class="glyphicon glyphicon-remove" data-toggle="tooltip" data-original-title="Remove this audio from the hint"></span>
                                            </a>
                                        </div>

                        {#                        This div is injected with image controls when the dialog opens #}
                                        <label for="hintImageControls">Main Image</label>
                                        <div id="hintImageControls" class="form-group"></div>
                                        <div class="form-group row">
                                            <div class="col col-md-8">
                                                <div id="my-pulldown5"></div>
                                            </div>
                                            <div class="col col-xs-1">
                                                <a href="#"><span class="glyphicon glyphicon-question-sign" data-toggle="tooltip" data-original-title="Sets where the hints figure is placed.  It can replace the problem figure or be in the hint figure block (the default)"></span></a>
                                            </div>

                            {#                        An image placement selector.  When a hint dialog comes up, this will be given its attributes and select options #}


                                        </div>
                                    </div>
                                </div>
                            </div>
                            {#                        SEcond Accordian for media files table #}

                            <div class="card">
                                <div class="card-header" role="tab" id="headingTwo">
                                    <h5 class="mb-0">
                                        <a class="collapsed" data-toggle="collapse" href="#collapseTwo" role="button" aria-expanded="false" aria-controls="collapseTwo">
                                            Other Hint Media
                                        </a>
                                    </h5>
                                </div>
                                <div id="collapseTwo" class="collapse" role="tabpanel" aria-labelledby="headingTwo" data-parent="#accordion">
                                    <div class="card-body">
                                        <p class="card-text">These files are usable within this hint.  They can be included in the statement by copy/pasting from the Ref file name (e.g. {[myfile.jpg]} )</p>

                                        <a id="addMedia" onclick="addHintMediaFile()" href="#hmediaTable"><span class="glyphicon glyphicon-plus" data-toggle="tooltip" data-original-title="Add a media file"></span></a>


                                        <table id="hmediaTable" class="table table-bordered">
                                            <thead>
                                            <tr><td style="width: 60px">Delete</td><th style="width: 60px">ID</th><th style="width: 60px">Ref file name</th><td>Upload</td></tr>
                                            </thead>
                                            <tbody id="hmediatbody">
                                            </tbody>
                                        </table>
                                        <div style="color:red;" id="hmediaFileErrorMessages">

                                        </div>
                                    </div>
                                </div>
                            </div>


                        </div>
                    <p style="color:red;"  id="hintSaveMessage"></p>
                    </form>
                </div>


                <div class="modal-footer">
{#                    <button onClick="saveHint({{ problem.id }});" class="btn btn-success"><span class="glyphicon glyphicon-save"></span>Save</button>#}
{#                    <button id="hintSave" onClick="$('#hintForm').submit();" class="btn btn-success"><span class="glyphicon glyphicon-save"></span>Save</button>#}
                    <button id="hintSave" class="btn btn-primary"><span class="glyphicon glyphicon-send"></span>Save and Continue</button>
                    <button id="hintSaveExit" class="btn btn-success"><span class="glyphicon glyphicon-save"></span>Save and Exit</button>
                    <button type="button" class="btn btn-danger btn-default" data-dismiss="modal">Cancel</button>
                </div>
            </div>

        </div>
    </div>
    {% endif %}



{% endblock %}

{#  Dialog that previews the problem #}



